(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2a97858c"],{"3b6c":function(e,a,t){"use strict";t.r(a);var n=function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("div",{class:e.prefix},[t("main",{class:e.prefix+"_window"},[t("div",{class:e.prefix+"_chat"},[t("header",{class:e.prefix+"_header"},[e._v(e._s(e.showImageBtn?"客服":e.joinData.receiverName))]),t("main",{class:e.prefix+"_main"},[t("com-body",{attrs:{data:e.messages,imUser:e.joinData,hasMore:e.connected&&e.hasMore,onSend:e.sendMsg,onLoadmore:e.onLoadmore}})],1),t("footer",{class:e.prefix+"_footer"},[t("com-footer",{attrs:{onSend:e.sendMsg,showImageBtn:e.showImageBtn,connected:e.connected&&!e.isEnd,loading:e.footerLoading}},[t("template",{slot:"toolbar"},[e.showTransferBtn?t("el-link",{staticClass:"tool-btn",attrs:{underline:!1,icon:"el-icon-service",title:"转人工"},on:{click:e.onTransferArtificial}}):e._e()],1)],2)],1)]),t("aside",{class:e.prefix+"_aside"},[t("header",{class:e.prefix+"_header"},[e._v("企业信息")]),t("main",{class:e.prefix+"_main"},[t("el-form",{class:e.prefix+"_company-info",attrs:{"label-width":"5em"}},[t("el-form-item",{attrs:{label:"企业名称"}},[e._v(e._s(e.inviteData.dialogName))]),t("el-form-item",{attrs:{label:"企业地址"}},[e._v(e._s(e.inviteData.dialogAddress))]),t("el-form-item",{attrs:{label:"联系电话"}},[e._v(e._s(e.inviteData.dialogPhone))]),t("el-form-item",{attrs:{label:"企业邮箱"}},[e._v(e._s(e.inviteData.dialogMail))])],1)],1),t("footer",{class:e.prefix+"_footer"},[t("p",{class:e.prefix+"_intro"},[e._v(e._s(e.inviteData.dialogIntroduction))])])])])])},r=[],s=t("2909"),i=t("3835"),c=t("15fd"),o=t("5530"),d=t("1da1"),u=(t("96cf"),t("caad"),t("d3b7"),t("159b"),t("b64b"),t("e9c4"),t("7db0"),t("bd90")),m=t("934a"),p=t("0eec"),f=t("5b48"),l=["sequenceId"],g=null;m["i"].start();var v={components:{ComBody:p["a"],ComFooter:f["a"]},provide:function(){return{inClient:!0,parentVM:this}},data:function(){return{prefix:"page-chat",messages:[],joinData:{},hasMore:!0,footerLoading:!1,isEnd:!1}},computed:{inviteData:function(){return this.joinData.inviteData||{}},connected:function(){return["webimnew","ainew"].indexOf(this.joinData.cmdType)>-1&&this.joinData.receiverId},showTransferBtn:function(){return"ainew"===this.joinData.cmdType},showImageBtn:function(){return"webimnew"===this.joinData.cmdType}},mounted:function(){this.init()},methods:{init:function(){var e=this;return Object(d["a"])(regeneratorRuntime.mark((function a(){var t,n,r,s;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(t=e.$route.params.id,n=e.$route.query,!t||!n.orgi){a.next=23;break}return a.next=5,u["a"](Object(o["a"])({appId:t},n));case 5:return r=a.sent,e.joinData=Object(o["a"])(Object(o["a"])({},r),{},{queryParams:n}),a.next=9,e.getChatRecords();case 9:if("leavemsg"!==r.cmdType){a.next=13;break}e.addMsg(r),a.next=23;break;case 13:if(!["webimnew","inservice"].includes(r.cmdType)){a.next=17;break}e.onTransferArtificial(),a.next=23;break;case 17:if("ainew"!==r.cmdType){a.next=23;break}return a.next=20,u["c"](r);case 20:s=a.sent,e.messages.push(s),e.joinData=Object(o["a"])(Object(o["a"])({},e.joinData),{},{sequenceId:s.sequenceId,receiverName:s.ext.senderName,receiverId:s.senderId,sessionId:s.ext.sessionId});case 23:case"end":return a.stop()}}),a)})))()},onTransferArtificial:function(){var e=this;return Object(d["a"])(regeneratorRuntime.mark((function a(){var t,n;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return e.footerLoading=!0,a.prev=1,a.next=4,e.$http("/im/webimnewBefore",{params:{orgi:e.joinData.orgi,appId:e.joinData.appId}});case 4:t=a.sent,n=t.data,n&&"leavemsg"===n.cmdType?(e.addMsg(m["b"]({cmdType:"system",content:"".concat(n.message,' <a data-action="leavemsg">点击留言</a>'),createTime:+new Date,sequenceId:m["d"](e.messages)})),e.joinData=Object(o["a"])(Object(o["a"])({},e.joinData),{},{cmdType:"leavemsg"})):(e.createWS(),e.joinData=Object(o["a"])(Object(o["a"])({},e.joinData),{},{cmdType:"webimnew"})),a.next=11;break;case 9:a.prev=9,a.t0=a["catch"](1);case 11:e.footerLoading=!1;case 12:case"end":return a.stop()}}),a,null,[[1,9]])})))()},addMsg:function(e){var a=this,t=m["l"](e.ext),n=(t.sequenceId,Object(c["a"])(t,l));Object.keys(n).forEach((function(t){a.$set(e,t,n[t])})),this.messages.push(e)},sendMsg:function(e){var a=this;return Object(d["a"])(regeneratorRuntime.mark((function t(){var n,r,s,i,c,d,p,f;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=a.joinData,r=a.messages,s=n.queryParams,i=void 0===s?{}:s,c="ainew"===n.cmdType,e=m["b"](Object(o["a"])({senderId:n.userid,receiverId:n.receiverId,sequenceId:m["d"](r),source:"client",ext:{sequenceId:n.sequenceId||"",orgi:n.orgi,receiverName:n.receiverName,senderName:n.nickname,agentserviceid:c?n.aiid:n.agentserviceid,sessionId:n.sessionId,appId:n.appId,email:i.email,phone:i.phone}},e)),d=JSON.parse(JSON.stringify(e)),a.addMsg(e),!c){t.next=22;break}return t.prev=7,t.next=10,u["b"].post("/ai/chatMessage",d);case 10:p=t.sent,f=p.data,n.sequenceId=f.sequenceId,a.$set(e,"state",1),"true"===f.artificial?a.onTransferArtificial():a.addMsg(f),t.next=20;break;case 17:t.prev=17,t.t0=t["catch"](7),a.$set(e,"state",-1);case 20:t.next=24;break;case 22:e.messageType===m["j"].TEXT&&m["q"](g,e),m["i"].push(e);case 24:return t.abrupt("return",e);case 25:case"end":return t.stop()}}),t,null,[[7,17]])})))()},sendHeart:function(){var e=this.joinData.queryParams,a=void 0===e?{}:e;m["q"](g,{cmdType:"heartbeat",senderId:this.joinData.userid,content:"ping",ext:{orgi:this.joinData.orgi,email:a.email,phone:a.phone}})},getChatRecords:function(){var e=this;return Object(d["a"])(regeneratorRuntime.mark((function a(){var t,n,r,c,o,d;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return n=Object(i["a"])(e.messages,1),r=n[0],c=e.joinData,a.next=4,u["b"]("/chatMessage/moremsg",{params:{size:30,source:"client",orgi:c.orgi,userid:c.userid,messageId:r?r.messageId:""}});case 4:return o=a.sent,d=o.data,(t=e.messages).unshift.apply(t,Object(s["a"])(d)),a.abrupt("return",d);case 8:case"end":return a.stop()}}),a)})))()},onLoadmore:function(){var e=this;return Object(d["a"])(regeneratorRuntime.mark((function a(){var t;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.next=2,e.getChatRecords();case 2:return t=a.sent,e.hasMore=t.length>0,a.abrupt("return",t);case 5:case"end":return a.stop()}}),a)})))()},createWS:function(){var e=this;g=m["c"]({onmessage:function(a){var t=a.cmdType,n=m["l"](a.ext),r=function(){e.joinData=Object(o["a"])(Object(o["a"])({},e.joinData),{},{receiverName:n.receiverName,receiverId:a.receiverId,agentserviceid:n.agentserviceid})};if("heartbeat"!==t&&m["r"](a),"allot"===t)r(),e.addMsg(a);else if("inservice"===t)r();else if("heartbeat"===t)m["e"].start(g,e.sendHeart.bind(e));else if("ack"===t){var s=e.messages.find((function(e){return+e.sequenceId===+a.sequenceId}));s&&(e.$set(s,"state",1),e.$set(s,"createTime",+a.createTime),e.$set(s,"messageId",a.messageId))}else a.messageId&&m["q"](g,{cmdType:"ack",messageId:a.messageId,receiverId:a.receiverId}),"message"===t?(e.addMsg(a),e.joinData=Object(o["a"])(Object(o["a"])({},e.joinData),{},{receiverName:n.senderName,receiverId:a.senderId,agentserviceid:n.agentserviceid,sessionId:n.sessionId})):"end"===t?(e.isEnd=!0,e.addMsg(a)):"satisfact"===t&&u["d"]({data:Object(o["a"])({},e.joinData),onSuccess:function(){e.addMsg({source:"system",content:"评价提交成功，感谢您的参与！",createTime:+new Date})}})},onopen:function(){var a=e.joinData,t=a.queryParams,n=void 0===t?{}:t;m["e"].start(g,e.sendHeart.bind(e)),m["q"](g,{cmdType:"webimnew",senderId:a.userid,ext:{orgi:a.orgi,senderName:a.nickname,sessionId:a.sessionId,appId:a.appId,ip:a.ip,osname:a.osname,browser:a.browser,email:n.email,phone:n.phone,channel:a.channel}}),e.footerLoading=!1},onclose:function(){m["n"](e.createWS.bind(e))}},!0)}}},b=v,h=(t("5f8b"),t("2877")),j=Object(h["a"])(b,n,r,!1,null,null,null);a["default"]=j.exports},"5f8b":function(e,a,t){"use strict";t("da96")},da96:function(e,a,t){}}]);
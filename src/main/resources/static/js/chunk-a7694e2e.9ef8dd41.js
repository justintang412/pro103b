(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-a7694e2e"],{"111a":function(e,t,n){"use strict";n.r(t);n("d3b7"),n("3ca3"),n("ddb0");var r="im",a=n("15fd"),s=n("3835"),i=n("1da1"),c=n("ade3"),o=n("5530"),u=n("2909"),d=(n("96cf"),n("4de4"),n("99af"),n("7db0"),n("e9c4"),n("159b"),n("b64b"),n("c740"),n("d81d"),n("4328")),m=n.n(d),g=n("934a"),S=["ext"],f=null,E=!1,T="current_session",l=function(){var e=sessionStorage.getItem(T);try{return JSON.parse(e)||[]}catch(t){return[]}};g["i"].start();var O=function(e){var t=e.Vue,n=t.prototype,r=n.$imHttp,d=n.$imPost;return{namespaced:!0,state:{connected:!1,currentSession:l(),historySession:[],blacklistSession:[],imState:g["f"].OFFLINE.value,chatRecords:{},unreadCountRecords:{},queueNum:0,activeSession:{}},getters:{historySession:function(e){return e.historySession.filter((function(t){return e.currentSession.every((function(e){return e.userid!==t.userid}))}))},allSession:function(e,t){return[].concat(Object(u["a"])(e.currentSession),Object(u["a"])(t.historySession),Object(u["a"])(e.blacklistSession))},getSession:function(e,t){return function(e){return t.allSession.find((function(t){return t.userid===e}))}},currentSession:function(e){return e.currentSession.reduce((function(e,t){return"inservice"===t.status?Object(o["a"])(Object(o["a"])({},e),{},{online:[].concat(Object(u["a"])(e.online),[t])}):Object(o["a"])(Object(o["a"])({},e),{},{offline:[].concat(Object(u["a"])(e.offline),[t])})}),{online:[],offline:[]})}},mutations:{SET_ACTIVE_SESSION:function(e,t){e.activeSession=t||{}},SET_IM_STATE:function(e,t){e.imState=t},SET_CURRENT_SESSION:function(e,t){e.currentSession=t,sessionStorage.setItem(T,JSON.stringify(t))},SET_HISTORY_SESSION:function(e,t){e.historySession=t},SET_BLACKLIST_SESSION:function(e,t){e.blacklistSession=t},SET_CHAT_RECORD:function(e,t){var n=t.userid,r=t.data,a=e.chatRecords[n];a?a.unshift.apply(a,Object(u["a"])(r)):e.chatRecords=Object(o["a"])(Object(o["a"])({},e.chatRecords),{},Object(c["a"])({},n,r))},ADD_MSG:function(e,n){var r=n.message,a=n.isSelf,s=g["l"](r.ext);Object.keys(s).forEach((function(e){t.set(r,e,s[e])}));var i=a?r.receiverId:r.senderId;if(!a){var u=e.currentSession;u.findIndex((function(e){return e.userid===i}))<0&&u.push(Object(o["a"])(Object(o["a"])({},r),{},{agentname:r.receiverName,userid:r.senderId,agentno:r.receiverId,nickname:r.senderName,username:r.senderName,status:"inservice"}))}var d=e.chatRecords[i];d?d.push(r):e.chatRecords=Object(o["a"])(Object(o["a"])({},e.chatRecords),{},Object(c["a"])({},i,[r]))},UPDATE_UNREAD_COUNT:function(e,t){e.unreadCountRecords=Object(o["a"])(Object(o["a"])({},e.unreadCountRecords),t)},SET_CONNECT_STATE:function(e,t){e.connected=t},UPDATE_QUEUE_NUM:function(e,t){e.queueNum=t}},actions:{SET_IM_STATE:function(e,t){return Object(i["a"])(regeneratorRuntime.mark((function n(){var a,s,i,o,u,d;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(s=e.commit,i=e.rootGetters,o=i.imUser,u={agentId:o.agentId,orgi:o.orgi,userName:o.nickname},d=(a={},Object(c["a"])(a,g["f"].ONLINE.value,"/agent/ready"),Object(c["a"])(a,g["f"].OFFLINE.value,"/agent/notready"),Object(c["a"])(a,g["f"].BUSY.value,"/agent/busy"),Object(c["a"])(a,g["f"].IDLE.value,"/agent/notbusy"),a)[t],!d){n.next=8;break}return n.next=7,r.post(d,m.a.stringify(u));case 7:s("SET_IM_STATE",t);case 8:case"end":return n.stop()}}),n)})))()},GET_HISTORY_SESSION:function(e){return Object(i["a"])(regeneratorRuntime.mark((function t(){var n,a,s,i,c;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.rootGetters,a=e.commit,s=n.imUser,t.next=4,r("/agent/agentUserRelations",{params:{orgi:s.orgi,agentId:s.agentId}});case 4:i=t.sent,c=i.data,a("SET_HISTORY_SESSION",c.map((function(e){return Object(o["a"])({nickname:e.username},e)})));case 7:case"end":return t.stop()}}),t)})))()},GET_BLACKLIST_SESSION:function(e){return Object(i["a"])(regeneratorRuntime.mark((function t(){var n,a,s,i;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,a=e.rootGetters,t.next=3,r("/agent/blacklist/list",{params:a.imUser});case 3:s=t.sent,i=s.data,n("SET_BLACKLIST_SESSION",i.map((function(e){return Object(o["a"])(Object(o["a"])({},e),{},{nickname:e.agentuser})})));case 6:case"end":return t.stop()}}),t)})))()},GET_CHAT_RECORD:function(e,t){return Object(i["a"])(regeneratorRuntime.mark((function n(){var r,a,i,c,o,u,d,m;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.state,a=e.commit,i=e.dispatch,c=r.chatRecords[t]||[],o=Object(s["a"])(c,1),u=o[0],n.next=4,i("GET_HISTORY_CHAT_RECORD",{userid:t,source:"agent",messageId:u&&u.messageId||""});case 4:return d=n.sent,m=d.data,a("SET_CHAT_RECORD",{userid:t,data:m}),n.abrupt("return",m);case 8:case"end":return n.stop()}}),n)})))()},GET_UNREAD_COUNT:function(e,t){return Object(i["a"])(regeneratorRuntime.mark((function n(){var a,s,i,o,u,d;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return a=e.commit,s=e.rootGetters,i=e.getters,o=i.getSession(t),n.next=4,r("/chatMessage/noReadCnt",{params:{orgi:s.imUser.orgi,agentserviceid:o.agentserviceid}});case 4:u=n.sent,d=u.data,a("UPDATE_UNREAD_COUNT",Object(c["a"])({},t,d));case 7:case"end":return n.stop()}}),n)})))()},RESET_UNREAD_COUNT:function(e,t){return Object(i["a"])(regeneratorRuntime.mark((function n(){var a,s,i,o,u,d,g;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(a=e.state,s=e.commit,i=e.rootGetters,o=e.getters,u=(a.chatRecords[t]||[]).filter((function(e){return e.messageId})),d=u[u.length-1],g=o.getSession(t),!g){n.next=7;break}return n.next=7,r.post("/chatMessage/noReadCnt",m.a.stringify({agentserviceid:g.agentserviceid,orgi:i.imUser.orgi,noreadMessageId:d?d.messageId:0}));case 7:s("UPDATE_UNREAD_COUNT",Object(c["a"])({},t,0));case 8:case"end":return n.stop()}}),n)})))()},CREATE_WS:function(e){var n=e.state,r=e.commit,a=e.dispatch,s=e.rootGetters;f=g["c"]({onmessage:function(e){var s=e.cmdType,i=g["l"](e.ext);if("heartbeat"===s)r("UPDATE_QUEUE_NUM",i.queueNum),i.agentUserList&&r("SET_CURRENT_SESSION",i.agentUserList),g["e"].start(f,(function(){return a("SEND_HB_MSG")}));else if("ack"===s){console.log("收到ack消息：",e);var o=n.chatRecords[e.receiverId]||[],u=o.find((function(t){return+t.sequenceId===+e.sequenceId}));u&&(t.set(u,"state",1),t.set(u,"createTime",+e.createTime),t.set(u,"messageId",e.messageId))}else if("message"===s){console.log("收到新消息：",e),r("ADD_MSG",{message:e,isSelf:!1}),g["g"](e),g["q"](f,{cmdType:"ack",messageId:e.messageId,receiverId:e.receiverId});var d=n.activeSession.userid;if(d&&d===e.senderId)return a("RESET_UNREAD_COUNT",d);r("UPDATE_UNREAD_COUNT",Object(c["a"])({},e.senderId,(n.unreadCountRecords[e.senderId]||0)+1))}else"agentconn"===s?console.log("坐席接入：",e):console.log("其它消息：",e)},onopen:function(){r("SET_CONNECT_STATE",!0),g["e"].start(f,(function(){return a("SEND_HB_MSG")}));var e=s.imUser;g["q"](f,{cmdType:"agentconn",senderId:e.agentId,ext:{orgi:e.orgi,senderName:e.nickname}}),E&&(E=!1,a("GET_HISTORY_SESSION"))},onclose:function(){E=!0,g["n"]((function(){return a("CREATE_WS")}))}})},SEND_MESSAGE:function(e,t){var n=e.state,r=e.commit,s=e.rootGetters;return new Promise((function(e,i){if(n.imState===g["f"].OFFLINE.value)return i(new Error("你已处理离线状态，无法发送消息！请在线后，重试"));var c=t.ext,u=void 0===c?{}:c,d=Object(a["a"])(t,S),m=s.imUser,E=n.chatRecords[t.receiverId]||[],T=g["b"](Object(o["a"])({senderId:m.agentId,sequenceId:g["d"](E),source:"agent",ext:Object(o["a"])(Object(o["a"])({},u),{},{orgi:m.orgi,senderName:m.nickname})},d));T.messageType===g["j"].TEXT&&g["q"](f,T),r("ADD_MSG",{message:T,isSelf:!0}),g["i"].push(T),e(T)}))},SEND_HB_MSG:function(e){var t=e.rootGetters,n=t.imUser;g["q"](f,{cmdType:"heartbeat",senderId:n.agentId,content:"ping",source:g["h"].AGENT,ext:{orgi:n.orgi}})},GET_HISTORY_CHAT_RECORD:function(e){var t=e.rootGetters,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return r("/chatMessage/moremsg",{params:Object(o["a"])(Object(o["a"])({},n),{},{orgi:t.imUser.orgi,size:30})})},GET_AGENT_STATUS:function(e){return Object(i["a"])(regeneratorRuntime.mark((function t(){var n,a,s,i,c,o;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,a=e.rootGetters,s=g["f"],i=a.imUser,t.next=5,r("/agent/status",{params:{orgi:i.orgi,agentId:i.agentId}});case 5:c=t.sent,o=c.data,n("SET_IM_STATE",{ready:s.ONLINE.value,notready:s.OFFLINE.value,busy:s.BUSY.value,idle:s.IDLE.value}[o||"notready"]);case 8:case"end":return t.stop()}}),t)})))()},SEND_EVALUATION:function(e,t){return Object(i["a"])(regeneratorRuntime.mark((function n(){var r,a,s,i,c;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,a=e.rootGetters,s=a.imUser,n.next=4,d("/agent/satisfact",Object(o["a"])({orgi:s.orgi,agentno:s.agentId},t));case 4:i=n.sent,c=i.data,r("ADD_MSG",{isSelf:!0,message:{source:"system",createTime:+new Date,content:c,receiverId:t.userid}});case 7:case"end":return n.stop()}}),n)})))()}}}},_=[{path:"/".concat(r),meta:{title:"在线客服",icon:"service",permissionTag:"im"},children:[{path:"blacklist",component:function(){return n.e("chunk-2d221c41").then(n.bind(null,"cc6a"))},meta:{title:"在线黑名单",permissionTag:"im_blacklist"}},{path:"leavemessage",component:function(){return n.e("chunk-2d0e9b14").then(n.bind(null,"8f2b"))},meta:{title:"在线留言",permissionTag:"im_leavemessage"}},{name:"".concat(r,"-chat"),path:"chat",component:function(){return Promise.all([n.e("chunk-4e17707c"),n.e("chunk-5974123a")]).then(n.bind(null,"37a8"))},meta:{title:"在线客服",notInsideMenu:!0,noLayout:!0,hideInsideMenu:!0,permissionTag:"service_online"}}]}];t["default"]=function(e){return{name:"im",routes:_,store:O(e)}}},c740:function(e,t,n){"use strict";var r=n("23e7"),a=n("b727").findIndex,s=n("44d2"),i="findIndex",c=!0;i in[]&&Array(1)[i]((function(){c=!1})),r({target:"Array",proto:!0,forced:c},{findIndex:function(e){return a(this,e,arguments.length>1?arguments[1]:void 0)}}),s(i)}}]);